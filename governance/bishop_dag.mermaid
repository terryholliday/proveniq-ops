%%{init: {'theme': 'dark', 'themeVariables': { 'primaryColor': '#00D4FF', 'primaryTextColor': '#fff', 'primaryBorderColor': '#00D4FF', 'lineColor': '#5A6A7E', 'secondaryColor': '#12181F', 'tertiaryColor': '#1A2129'}}}%%

graph TD
    %% ========================================================================
    %% BISHOP DECISION DAG - Visual Representation
    %% Signals detect. Policy decides. Proposals package.
    %% Approvals authorize. Execution commits. Telemetry proves.
    %% ========================================================================

    %% Layer 0: Canonical Data Contracts
    subgraph L0["Layer 0: Canonical Data Contracts"]
        N0[N0: Identity & Context]
        N1[N1: Inventory Snapshot]
        N2[N2: Scan Normalization]
        N3[N3: SKU Normalization]
        N4[N4: Liquidity Snapshot]
    end

    %% Layer 1: Signals
    subgraph L1["Layer 1: Signals (Pure Detection)"]
        N10[N10: Demand Forecast]
        N11[N11: Stockout Risk]
        N12[N12: Ghost Inventory]
        N13[N13: Expiration Risk]
        N14[N14: Price Delta]
        N15[N15: Scan Anomaly]
        N16[N16: Receiving Reconciliation]
        N17[N17: Menu Cost]
        N18[N18: Location Imbalance]
    end

    %% Layer 2: Policy Gates
    subgraph L2["Layer 2: Policy Gates"]
        N20[N20: Liquidity Gate]
        N21[N21: Criticality Policy]
        N22[N22: Approval Policy]
        N23[N23: Vendor Policy]
        N24[N24: Disposition Policy]
        N25[N25: Priority Scoring]
    end

    %% Layer 3: Proposals
    subgraph L3["Layer 3: Proposals (Ready-to-Approve)"]
        N30[N30: Reorder Proposal]
        N31[N31: Emergency Reorder]
        N32[N32: Receiving Adjustment]
        N33[N33: Expiration Plan]
        N34[N34: Vendor Switch]
        N35[N35: Transfer Proposal]
        N36[N36: Anomaly Review]
        N37[N37: Margin Alert]
    end

    %% Layer 4: Execution
    subgraph L4["Layer 4: Execution (Approval Required)"]
        N40[N40: Approval Intake]
        N41[N41: Execute PO]
        N42[N42: Execute Vendor Switch]
        N43[N43: Execute Transfer]
        N44[N44: Apply Receiving]
        N45[N45: Execute Expiration]
        N46[N46: Waste Autopsy]
    end

    %% Layer 5: Telemetry
    subgraph L5["Layer 5: Telemetry (Audit & Metrics)"]
        N50[N50: Ledger Posting]
        N51[N51: Efficiency Metrics]
        N52[N52: Audit Trail]
    end

    %% ========================================================================
    %% DEPENDENCIES
    %% ========================================================================

    %% Layer 0 → Layer 1
    N1 --> N10
    N2 --> N10
    N10 --> N11
    N3 --> N11
    N1 --> N12
    N2 --> N12
    N1 --> N13
    N3 --> N14
    N2 --> N15
    N2 --> N16
    N1 --> N16
    N3 --> N16
    N1 --> N17
    N1 --> N18
    N10 --> N18

    %% Layer 1 → Layer 2
    N4 --> N20
    N1 --> N21
    N0 --> N22
    N3 --> N23
    
    %% All signals feed into Priority Scoring
    N11 --> N25
    N12 --> N25
    N13 --> N25
    N14 --> N25
    N15 --> N25
    N16 --> N25
    N17 --> N25
    N18 --> N25
    N20 --> N25
    N21 --> N25
    N22 --> N25
    N23 --> N25
    N24 --> N25

    %% Layer 2 → Layer 3
    N11 --> N30
    N21 --> N30
    N23 --> N30
    N20 --> N30

    N11 --> N31
    N21 --> N31
    N23 --> N31
    N20 --> N31

    N16 --> N32
    N22 --> N32

    N13 --> N33
    N24 --> N33

    N14 --> N34
    N23 --> N34

    N18 --> N35
    N22 --> N35

    N15 --> N36
    N0 --> N36

    N17 --> N37

    %% Layer 3 → Layer 4
    N30 --> N41
    N31 --> N41
    N40 --> N41
    N20 --> N41

    N34 --> N42
    N40 --> N42

    N35 --> N43
    N40 --> N43

    N32 --> N44
    N40 --> N44

    N33 --> N45
    N40 --> N45

    N45 --> N46

    %% Layer 4 → Layer 5
    N41 --> N50
    N44 --> N50
    N45 --> N50

    N41 --> N51
    N42 --> N51
    N43 --> N51
    N44 --> N51
    N45 --> N51

    %% ========================================================================
    %% STYLING
    %% ========================================================================

    classDef layer0 fill:#0A0E14,stroke:#00D4FF,stroke-width:2px,color:#00D4FF
    classDef layer1 fill:#12181F,stroke:#00FF88,stroke-width:2px,color:#00FF88
    classDef layer2 fill:#12181F,stroke:#FFB800,stroke-width:2px,color:#FFB800
    classDef layer3 fill:#12181F,stroke:#7B61FF,stroke-width:2px,color:#7B61FF
    classDef layer4 fill:#12181F,stroke:#FF4757,stroke-width:2px,color:#FF4757
    classDef layer5 fill:#12181F,stroke:#5A6A7E,stroke-width:2px,color:#8B9CB3

    class N0,N1,N2,N3,N4 layer0
    class N10,N11,N12,N13,N14,N15,N16,N17,N18 layer1
    class N20,N21,N22,N23,N24,N25 layer2
    class N30,N31,N32,N33,N34,N35,N36,N37 layer3
    class N40,N41,N42,N43,N44,N45,N46 layer4
    class N50,N51,N52 layer5
